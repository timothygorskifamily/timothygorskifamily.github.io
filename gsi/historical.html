<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GSI Theoretical Historical Strategy Analysis Prototype</title>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/noUiSlider/15.7.0/nouislider.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/noUiSlider/15.7.0/nouislider.min.css">

    <style>
        :root { 
            --primary: #0f172a; 
            --accent: #3b82f6; 
            --bg: #f8fafc; 
            --card: #ffffff; 
            --border: #e2e8f0; 
            --text-sub: #64748b;
        }

        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; background: var(--bg); color: #334155; margin: 0; padding: 20px; }
        .container { max-width: 1400px; margin: auto; background: var(--card); padding: 30px; border-radius: 16px; box-shadow: 0 10px 25px -5px rgba(0,0,0,0.1); }
        .nav-bar { display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px; background: white; padding: 0 20px; height: 64px; border-bottom: 1px solid var(--border); border-radius: 8px; }
        .logo-text { font-size: 1.5rem; font-weight: 700; color: #1e3a8a; text-decoration: none; }
        .logo-dot { color: #d97706; }
        .nav-links { display: flex; gap: 30px; }
        .nav-link { text-decoration: none; color: #4b5563; font-weight: 500; font-size: 0.95rem; }
        .nav-link.active { color: #1e40af; font-weight: 600; }
        .header { display: flex; justify-content: space-between; align-items: flex-end; border-bottom: 2px solid var(--border); padding-bottom: 20px; margin-bottom: 25px; }
        h1 { margin: 0; font-size: 1.8rem; color: var(--primary); }
        .sub { font-size: 0.95rem; color: #64748b; margin-top: 5px; font-weight: 500; }
        .badge { background: #f1f5f9; color: #64748b; padding: 6px 12px; border-radius: 6px; font-weight: 800; font-size: 0.8rem; text-transform: uppercase; }
        
        .formula-bar { background: #eff6ff; border: 1px solid #bfdbfe; color: #1e40af; padding: 12px; border-radius: 8px; text-align: center; font-weight: 600; margin-bottom: 25px; display: flex; justify-content: center; gap: 15px; }
        .controls-wrapper { background: #f8fafc; border: 1px solid var(--border); border-radius: 12px; padding: 25px; margin-bottom: 25px; }
        .controls-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 30px; margin-bottom: 20px; align-items: start; }
        .section-title { font-size: 0.75rem; text-transform: uppercase; font-weight: 700; color: var(--text-sub); margin-bottom: 15px; border-bottom: 1px solid var(--border); padding-bottom: 5px; }
        .input-group { margin-bottom: 15px; }
        .input-group label { display: block; font-size: 0.85rem; font-weight: 600; margin-bottom: 6px; color: var(--primary); }
        input[type="number"], select, input[type="text"] { width: 100%; padding: 10px; border: 1px solid var(--border); border-radius: 6px; font-size: 0.95rem; box-sizing: border-box; background: #fff; color: var(--primary); }
        input:disabled { background: #f1f5f9; color: #94a3b8; }
        
        .toggles { display: flex; gap: 20px; flex-wrap: wrap; padding-top: 15px; border-top: 1px solid var(--border); align-items: center; }
        .checkbox-lbl { font-size: 0.9rem; font-weight: 500; display: flex; align-items: center; gap: 8px; cursor: pointer; color: var(--primary); }
        .chart-section { background: #fff; border: 1px solid var(--border); border-radius: 12px; padding: 20px; margin-bottom: 25px; }
        .chart-wrapper { position: relative; height: 500px; width: 100%; }
        #dateSlider { margin: 0 20px 40px 20px; height: 10px; }
        .noUi-connect { background: var(--accent); }

        .metrics { display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 15px; }
        .metric-box { padding: 15px; border-radius: 12px; background: #f1f5f9; border: 1px solid var(--border); text-align: center; }
        .metric-box.blue { border-top: 4px solid #2563eb; }
        .metric-box.green { border-top: 4px solid #10b981; }
        .metric-box.orange { border-top: 4px solid #f97316; }
        .metric-box.gray { border-top: 4px solid #64748b; }
        .metric-box.purple { border-top: 4px solid #8b5cf6; }
        .metric-box.red { border-top: 4px solid #f43f5e; }
        .metric-val { font-size: 1.25rem; font-weight: 800; margin: 5px 0; color: var(--primary); }
        .metric-label { font-size: 0.75rem; text-transform: uppercase; font-weight: 700; color: var(--text-sub); }
        .metric-stats { display: flex; justify-content: center; gap: 8px; margin-top: 8px; }
        .stat-badge { font-size: 0.75rem; font-weight: 600; background: white; padding: 2px 6px; border-radius: 4px; border: 1px solid #e2e8f0; }
        .disclaimer-section { font-size: 0.7rem; color: #94a3b8; margin-top: 50px; padding-top: 30px; border-top: 1px solid var(--border); line-height: 1.5; }
    </style>
</head>
<body>

<div class="container">
    <nav class="nav-bar">
        <a href="https://gorskifamilyoffice.com/gsi/index.html" class="logo-text">GSI<span class="logo-dot">.</span>Explorer</a>
        <div class="nav-links">
            <a href="#" class="nav-link active">Historical Backtest</a>
            <a href="https://gorskifamilyoffice.com/gsi/psa.html" class="nav-link">Projections (PSA)</a>
        </div>
    </nav>

    <div class="header">
        <div>
            <h1>Historical Strategy Analysis <span style="font-size:0.5em; background:#f1f5f9; padding:4px 8px; border-radius:4px;">Prototype</span></h1>
            <div class="sub">Component Breakdown & Fee Adjustments (1974 - 2024)</div>
        </div>
        <div><span class="badge">Backtest Mode</span></div>
    </div>

    <div class="formula-bar">
        <span>ðŸ”µ GSI Total =</span>
        <span>ðŸŸ¢ Credit Yield (Safety)</span>
        <span>+</span>
        <span>ðŸŸ  Option Strategy (Net P&L)</span>
    </div>

    <div class="controls-wrapper">
        <div class="controls-grid">
            <div>
                <div class="section-title">Portfolio Settings</div>
                <div class="input-group">
                    <label>Initial Capital ($)</label>
                    <input type="number" id="startCap" value="250000" step="10000">
                </div>
                <div class="input-group">
                    <label>Underlying Asset</label>
                    <select id="underlyingAsset">
                        <option value="SPX" selected>S&P 500 (SPX)</option>
                        <option value="MSCI">MSCI World</option>
                    </select>
                </div>
            </div>

            <div>
                <div class="section-title">GSI Fee Structure</div>
                <div class="input-group">
                    <label>Management Fee (%)</label>
                    <input type="number" id="mgmtFee" value="0.5" step="0.1" min="0" max="5">
                </div>
                <div class="input-group">
                    <label>Performance Fee (Carry)</label>
                    <select id="perfFee">
                        <option value="0">0%</option>
                        <option value="0.07">7%</option>
                        <option value="0.10">10%</option>
                        <option value="0.20" selected>20%</option>
                    </select>
                </div>
            </div>

            <div>
                <div class="section-title">Strategy Calibration</div>
                <div class="input-group">
                    <label>Total Notional Leverage (x)</label>
                    <input type="number" id="leverageInput" value="2.6" step="0.1" min="0.5" max="5.0" style="font-weight:bold; color:var(--accent);">
                </div>
                <div class="input-group">
                    <label>Effective Participation</label>
                    <input type="text" id="effPart" value="~1.56x (Delta Adj)" disabled>
                </div>
            </div>
        </div>

        <div class="toggles">
            <strong style="font-size:0.9rem; align-self:center; margin-right:10px;">Display Layers:</strong>
            <label class="checkbox-lbl"><input type="checkbox" id="showCredit" checked> Credit Floor</label>
            <label class="checkbox-lbl"><input type="checkbox" id="showOption" checked> Option P&L</label>
            <label class="checkbox-lbl" style="border-left:1px solid #e2e8f0; padding-left:15px; margin-left:5px;"><input type="checkbox" id="showIndex" checked> <span id="toggleIdxLabel">S&P 500</span></label>
            <label class="checkbox-lbl"><input type="checkbox" id="showPE"> Private Equity</label>
            <label class="checkbox-lbl"><input type="checkbox" id="showBonds"> Bonds</label>
        </div>
    </div>

    <div class="chart-section">
        <div class="chart-wrapper"><canvas id="mainChart"></canvas></div>
        <div style="padding: 0 20px; margin-top:20px;">
            <p style="text-align:center; font-size:0.85rem; color:var(--text-sub); margin-bottom:25px;">Zoom History: 1974 - 2024</p>
            <div id="dateSlider"></div>
        </div>
    </div>

    <div class="metrics" id="metricsContainer"></div>
</div>

<script>
    // --- Data Processing (1974-2024) ---
    const rawData = [
        { year: 1974, rate: 10.5, spx: -26.47, bonds: 5.0,  pe: -20.5 },
        { year: 1975, rate: 5.8,  spx: 37.20,  bonds: 7.0,  pe: 45.0 },
        { year: 1976, rate: 5.0,  spx: 23.84,  bonds: 15.0, pe: 35.0 },
        { year: 1977, rate: 5.5,  spx: -7.18,  bonds: 3.0,  pe: -2.0 },
        { year: 1978, rate: 7.9,  spx: 6.56,   bonds: 1.0,  pe: 12.0 },
        { year: 1979, rate: 11.2, spx: 18.44,  bonds: 2.0,  pe: 25.0 },
        { year: 1980, rate: 13.3, spx: 32.50,  bonds: 3.0,  pe: 40.0 },
        { year: 1981, rate: 16.4, spx: -4.92,  bonds: 6.0,  pe: -5.0 },
        { year: 1982, rate: 12.2, spx: 21.55,  bonds: 32.0, pe: 28.0 },
        { year: 1983, rate: 9.1,  spx: 22.56,  bonds: 8.0,  pe: 25.0 },
        { year: 1984, rate: 10.2, spx: 6.27,   bonds: 15.0, pe: 10.0 },
        { year: 1985, rate: 8.1,  spx: 31.73,  bonds: 22.0, pe: 35.0 },
        { year: 1986, rate: 6.8,  spx: 18.67,  bonds: 15.0, pe: 20.0 },
        { year: 1987, rate: 6.6,  spx: 5.25,   bonds: 2.0,  pe: 8.0 },
        { year: 1988, rate: 7.5,  spx: 16.61,  bonds: 7.0,  pe: 22.0 },
        { year: 1989, rate: 9.2,  spx: 31.69,  bonds: 14.0, pe: 25.0 },
        { year: 1990, rate: 8.1,  spx: -3.10,  bonds: 8.0,  pe: -5.0 },
        { year: 1991, rate: 5.7,  spx: 30.47,  bonds: 16.0, pe: 35.0 },
        { year: 1992, rate: 3.5,  spx: 7.62,   bonds: 7.0,  pe: 15.0 },
        { year: 1993, rate: 3.0,  spx: 10.08,  bonds: 9.0,  pe: 18.0 },
        { year: 1994, rate: 4.2,  spx: 1.32,   bonds: -2.0, pe: 5.0 },
        { year: 1995, rate: 5.8,  spx: 37.58,  bonds: 18.0, pe: 40.0 },
        { year: 1996, rate: 5.3,  spx: 22.96,  bonds: 3.0,  pe: 28.0 },
        { year: 1997, rate: 5.5,  spx: 33.36,  bonds: 9.0,  pe: 32.0 },
        { year: 1998, rate: 5.3,  spx: 28.58,  bonds: 8.0,  pe: 25.0 },
        { year: 1999, rate: 5.0,  spx: 21.04,  bonds: -0.8, pe: 45.0 },
        { year: 2000, rate: 6.2,  spx: -9.10,  bonds: 11.0, pe: -5.0 },
        { year: 2001, rate: 3.8,  spx: -11.89, bonds: 8.0,  pe: -12.0 },
        { year: 2002, rate: 1.6,  spx: -22.10, bonds: 10.0, pe: -15.0 },
        { year: 2003, rate: 1.1,  spx: 28.68,  bonds: 4.0,  pe: 30.0 },
        { year: 2004, rate: 1.3,  spx: 10.88,  bonds: 4.3,  pe: 15.2 },
        { year: 2005, rate: 3.2,  spx: 4.91,   bonds: 2.4,  pe: 12.5 },
        { year: 2006, rate: 4.9,  spx: 15.79,  bonds: 4.3,  pe: 18.4 },
        { year: 2007, rate: 5.0,  spx: 5.49,   bonds: 6.9,  pe: 15.3 },
        { year: 2008, rate: 1.9,  spx: -37.0,  bonds: 5.2,  pe: -22.0 },
        { year: 2009, rate: 0.1,  spx: 26.46,  bonds: 5.9,  pe: 14.5 },
        { year: 2010, rate: 0.1,  spx: 15.06,  bonds: 6.5,  pe: 18.2 },
        { year: 2011, rate: 0.1,  spx: 2.11,   bonds: 7.8,  pe: 8.4 },
        { year: 2012, rate: 0.1,  spx: 16.00,  bonds: 4.2,  pe: 14.3 },
        { year: 2013, rate: 0.1,  spx: 32.39,  bonds: -2.0, pe: 21.5 },
        { year: 2014, rate: 0.1,  spx: 13.69,  bonds: 5.9,  pe: 12.8 },
        { year: 2015, rate: 0.1,  spx: 1.38,   bonds: 0.5,  pe: 9.1 },
        { year: 2016, rate: 0.4,  spx: 11.96,  bonds: 2.6,  pe: 13.5 },
        { year: 2017, rate: 1.0,  spx: 21.83,  bonds: 3.5,  pe: 19.8 },
        { year: 2018, rate: 1.8,  spx: -4.38,  bonds: 0.0,  pe: 6.5 },
        { year: 2019, rate: 2.1,  spx: 31.49,  bonds: 8.7,  pe: 18.7 },
        { year: 2020, rate: 0.3,  spx: 18.40,  bonds: 7.5,  pe: 24.5 },
        { year: 2021, rate: 0.05, spx: 28.71,  bonds: -1.5, pe: 32.6 },
        { year: 2022, rate: 1.6,  spx: -18.11, bonds: -13.0,pe: -4.5 },
        { year: 2023, rate: 5.0,  spx: 26.29,  bonds: 5.5,  pe: 8.5 },
        { year: 2024, rate: 5.3,  spx: 25.00,  bonds: 1.8,  pe: 9.0 }
    ];

    // Map synthetic MSCI approximation into the dataset for the prototype
    const historicalData = rawData.map(d => ({
        ...d,
        msci: Number((d.spx * 0.88 + (Math.random() * 2 - 1)).toFixed(2)) // Slight beta adjustment proxy
    }));

    const CONSTANTS = { CREDIT_SPREAD: 6.0, CREDIT_ALLOC: 0.48, OPTION_ALLOC: 0.52, START_DELTA: 0.60 };

    let myChart = null;
    let slider = null;

    function calculate(startYear, endYear) {
        const startCap = parseFloat(document.getElementById('startCap').value);
        const mgmtFeePct = parseFloat(document.getElementById('mgmtFee').value) / 100;
        const perfFeePct = parseFloat(document.getElementById('perfFee').value);
        const maxLeverage = parseFloat(document.getElementById('leverageInput').value);
        const underlying = document.getElementById('underlyingAsset').value;

        const subset = historicalData.filter(d => d.year >= startYear && d.year <= endYear);
        const labels = ['Start', ...subset.map(d => d.year)];
        
        const data = { total: [startCap], credit: [startCap], optionVal: [0], indexVal: [startCap], pe: [startCap], bonds: [startCap] };

        let hwmGSI = startCap;
        let hwmPE = startCap;

        subset.forEach(yr => {
            const prev = { total: data.total[data.total.length - 1], credit: data.credit[data.credit.length - 1], indexVal: data.indexVal[data.indexVal.length - 1], pe: data.pe[data.pe.length - 1], bonds: data.bonds[data.bonds.length - 1] };

            const dynamicYield = (yr.rate + CONSTANTS.CREDIT_SPREAD) / 100;
            data.credit.push(prev.credit * (1 + dynamicYield)); 

            // Switch Math to MSCI vs SPX dynamically
            const idxRet = (underlying === 'SPX' ? yr.spx : yr.msci) / 100;
            
            let participation = maxLeverage * CONSTANTS.START_DELTA;
            if(idxRet > 0) participation += (idxRet * 0.4); 
            if(idxRet < 0) participation -= (Math.abs(idxRet) * 0.4);
            if(participation > maxLeverage) participation = maxLeverage;
            if(participation < 0.2) participation = 0.2;

            let optionReturn = participation * idxRet;
            if(idxRet > -0.05 && idxRet < 0.05) optionReturn -= 0.03;
            if (optionReturn < -CONSTANTS.OPTION_ALLOC) optionReturn = -CONSTANTS.OPTION_ALLOC;

            const grossReturnGSI = (CONSTANTS.CREDIT_ALLOC * dynamicYield) + optionReturn;

            let valGrossGSI = prev.total * (1 + grossReturnGSI);
            let valPostMgmtGSI = valGrossGSI * (1 - mgmtFeePct);
            let finalValGSI = valPostMgmtGSI;

            if (valPostMgmtGSI > hwmGSI) {
                const fee = (valPostMgmtGSI - hwmGSI) * perfFeePct;
                finalValGSI = valPostMgmtGSI - fee;
                hwmGSI = finalValGSI;
            }

            data.total.push(finalValGSI);
            data.optionVal.push(finalValGSI - (prev.credit * (1 + dynamicYield)));

            const peGrossReturn = yr.pe / 100;
            let valPostMgmtPE = prev.pe * (1 + peGrossReturn) * (1 - 0.015); 
            let finalValPE = valPostMgmtPE;
            if (valPostMgmtPE > hwmPE) {
                finalValPE = valPostMgmtPE - ((valPostMgmtPE - hwmPE) * 0.20);
                hwmPE = finalValPE;
            }
            data.pe.push(finalValPE);
            data.indexVal.push(prev.indexVal * (1 + idxRet));
            data.bonds.push(prev.bonds * (1 + yr.bonds/100));
        });

        const years = subset.length;
        const stats = {
            total: getStats(startCap, data.total[data.total.length - 1], years),
            credit: getStats(startCap, data.credit[data.credit.length - 1], years),
            indexVal: getStats(startCap, data.indexVal[data.indexVal.length - 1], years),
            pe: getStats(startCap, data.pe[data.pe.length - 1], years),
            bonds: getStats(startCap, data.bonds[data.bonds.length - 1], years)
        };

        return { labels, data, stats };
    }

    function getStats(start, end, years) {
        if (years === 0) return { irr: 0, cumul: 0 };
        return { irr: ((Math.pow(end / start, 1 / years) - 1) * 100), cumul: ((end - start) / start) * 100 };
    }

    function updateChart() {
        const range = slider.noUiSlider.get().map(Number);
        const res = calculate(Math.round(range[0]), Math.round(range[1]));
        const ctx = document.getElementById('mainChart').getContext('2d');
        const curLev = parseFloat(document.getElementById('leverageInput').value);
        const underlying = document.getElementById('underlyingAsset').value;
        const idxName = underlying === 'SPX' ? 'S&P 500' : 'MSCI World';
        
        document.getElementById('effPart').value = `~${(curLev * CONSTANTS.START_DELTA).toFixed(2)}x (Delta Adj)`;
        document.getElementById('toggleIdxLabel').textContent = idxName;

        const datasets = [];
        const lbl = (name, s) => `${name} (Cumul: ${s.cumul.toFixed(0)}%)`;

        datasets.push({ label: lbl('GSI Total', res.stats.total), data: res.data.total, borderColor: '#2563eb', backgroundColor: 'rgba(37, 99, 235, 0.1)', borderWidth: 3, tension: 0.2, fill: true, order: 1 });

        if (document.getElementById('showCredit').checked) datasets.push({ label: lbl('Credit Floor', res.stats.credit), data: res.data.credit, borderColor: '#10b981', borderWidth: 2, borderDash: [5,5], pointRadius: 0, order: 2, fill: false });
        if (document.getElementById('showOption').checked) datasets.push({ label: 'Option Strategy Net P&L ($)', data: res.data.optionVal, borderColor: '#f97316', borderWidth: 2, pointRadius: 0, order: 3, fill: false });
        if (document.getElementById('showIndex').checked) datasets.push({ label: lbl(idxName, res.stats.indexVal), data: res.data.indexVal, borderColor: '#64748b', borderWidth: 2, pointRadius: 0, order: 4 });
        if (document.getElementById('showPE').checked) datasets.push({ label: lbl('Private Equity (Net)', res.stats.pe), data: res.data.pe, borderColor: '#8b5cf6', borderWidth: 2, pointRadius: 0, order: 5 });
        if (document.getElementById('showBonds').checked) datasets.push({ label: lbl('Bonds', res.stats.bonds), data: res.data.bonds, borderColor: '#f43f5e', borderWidth: 2, pointRadius: 0, order: 6 });

        if (myChart) {
            myChart.data.labels = res.labels;
            myChart.data.datasets = datasets;
            myChart.update();
        } else {
            myChart = new Chart(ctx, {
                type: 'line',
                data: { labels: res.labels, datasets: datasets },
                options: {
                    responsive: true, maintainAspectRatio: false, interaction: { mode: 'index', intersect: false },
                    plugins: { tooltip: { callbacks: { label: c => c.dataset.label + ': ' + new Intl.NumberFormat('en-US', { style: 'currency', currency: 'USD', maximumFractionDigits: 0 }).format(c.raw) } } },
                    scales: { y: { grid: { color: '#f1f5f9' }, ticks: { callback: v => '$' + v/1000 + 'k' } }, x: { grid: { display: false } } }
                }
            });
        }
        updateMetrics(res, idxName);
    }

    function updateMetrics(res, idxName) {
        const end = res.data.total.length - 1;
        const fmt = new Intl.NumberFormat('en-US', { style: 'currency', currency: 'USD', maximumFractionDigits:0 }).format;
        const mkBox = (lbl, val, stats, className) => `<div class="metric-box ${className}"><div class="metric-label">${lbl}</div><div class="metric-val">${fmt(val)}</div><div class="metric-stats"><span class="stat-badge">IRR: ${stats.irr.toFixed(1)}%</span><span class="stat-badge">Cum: ${stats.cumul.toFixed(0)}%</span></div></div>`;

        let html = mkBox('GSI Total (Net)', res.data.total[end], res.stats.total, 'blue');
        if (document.getElementById('showCredit').checked) html += mkBox('Credit Floor', res.data.credit[end], res.stats.credit, 'green');
        if (document.getElementById('showOption').checked) html += `<div class="metric-box orange"><div class="metric-label">Option P&L</div><div class="metric-val">${fmt(res.data.optionVal[end])}</div><div style="font-size:0.75rem; color:#94a3b8; margin-top:8px;">(Net vs Floor)</div></div>`;
        if (document.getElementById('showIndex').checked) html += mkBox(idxName, res.data.indexVal[end], res.stats.indexVal, 'gray');
        if (document.getElementById('showPE').checked) html += mkBox('Private Equity (Net)', res.data.pe[end], res.stats.pe, 'purple');
        if (document.getElementById('showBonds').checked) html += mkBox('Bonds', res.data.bonds[end], res.stats.bonds, 'red');

        document.getElementById('metricsContainer').innerHTML = html;
    }

    document.addEventListener('DOMContentLoaded', () => {
        slider = document.getElementById('dateSlider');
        noUiSlider.create(slider, { start: [1974, 2024], connect: true, range: { 'min': 1974, 'max': 2024 }, step: 1, tooltips: [true, true], format: { to: v => Math.round(v), from: v => Number(v) } });
        slider.noUiSlider.on('update', updateChart);
        
        ['startCap', 'mgmtFee', 'perfFee', 'leverageInput', 'underlyingAsset'].forEach(id => {
            document.getElementById(id).addEventListener(id === 'perfFee' || id === 'underlyingAsset' ? 'change' : 'input', updateChart);
        });

        ['showCredit', 'showOption', 'showIndex', 'showPE', 'showBonds'].forEach(id => {
            document.getElementById(id).addEventListener('change', updateChart);
        });
    });
</script>
</body>
</html>
